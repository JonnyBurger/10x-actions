"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var fs_1 = __importDefault(require("fs"));
var getInvocationLocationFromFile = function (str) {
    var _a;
    var line = str.split("\n")[2];
    // Parse the expression: (/Users/user/project/script.ts:7:4)
    return (_a = line.match(/\(((.*)):([0-9]+):([0-9]+)\)/)) === null || _a === void 0 ? void 0 : _a[1];
};
var removeExtensionOfPath = function (path) {
    var split = path.split(".");
    if (split.length === 1) {
        return path;
    }
    return split.slice(0, split.length - 1).join(".");
};
// match index.js with node index
var compareWithoutExtension = function (path1, path2) {
    return removeExtensionOfPath(path1) === removeExtensionOfPath(path2);
};
exports.xns = function (fn) {
    var line = getInvocationLocationFromFile(Error().stack);
    if (!line) {
        return fn;
    }
    if (compareWithoutExtension(fs_1.default.realpathSync(process.argv[1]), line)) {
        Promise.resolve(fn())
            .then(function (output) {
            if (typeof output !== "undefined") {
                console.log(output);
            }
            process.exit(0);
        })
            .catch(function (err) {
            console.error(err);
            process.exit(1);
        });
    }
    return fn;
};
exports.default = exports.xns;
